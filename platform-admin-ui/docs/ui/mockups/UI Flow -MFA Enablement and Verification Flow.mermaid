flowchart TD
    subgraph MFA Enablement Flow (US-018)
        A[User navigates to Security Settings] --> B{MFA Enabled?}
        B -->|Yes| C[Show 'MFA is Enabled' & 'Disable' option]
        B -->|No| D[User clicks 'Enable MFA']
        D --> E[Backend: Generate unique TOTP secret]
        E --> F[Frontend: Display QR Code & Secret Key]
        F --> G[User scans QR & enters 6-digit code]
        G --> H[Backend: Verify TOTP Code]
        H -->|Invalid| I[Show 'Invalid code' error]
        I --> G
        H -->|Valid| J[Backend: Encrypt & store secret, set MFA enabled]
        J --> K[Backend: Generate & hash recovery codes]
        K --> L[Frontend: Display Recovery Codes]
        L --> M[User confirms saving codes]
        M --> C
    end

    subgraph MFA Login Flow (US-019)
        P1[User enters Email + Password] --> P2{Backend: Credentials Valid?}
        P2 -->|No| P3[Show 'Invalid Credentials' error]
        P2 -->|Yes| P4{MFA Enabled for User?}
        P4 -->|No| P5[Issue JWTs & Login]
        P4 -->|Yes| P6[Frontend: Show MFA Code Input]
        P6 --> P7[User enters 6-digit TOTP code]
        P7 --> P8{Backend: TOTP Code Valid?}
        P8 -->|No| P9{Failed attempts < 5?}
        P9 -->|Yes| P10[Show 'Invalid code' error]
        P10 --> P7
        P9 -->|No| P11[Backend: Lock account for 15 min]
        P11 --> P12[Show 'Account locked' error]
        P8 -->|Yes| P5
    end

    %% Styling
    classDef userAction fill:#fff9c4,stroke:#fbc02d,color:#000
    classDef systemProcess fill:#e3f2fd,stroke:#2196f3,color:#000
    classDef decision fill:#e8eaf6,stroke:#3f51b5,color:#000
    classDef success fill:#e8f5e9,stroke:#4caf50,color:#000
    classDef error fill:#ffebee,stroke:#d32f2f,color:#000

    class A,D,G,M,P1,P7 userAction
    class E,H,J,K,P2,P4,P8,P11 systemProcess
    class B,P9 decision
    class C,L,P5 success
    class I,P3,P10,P12 error